#!/bin/bash

# This bash script (re)sets up the t-pcontext tools...
#
# In particular, it takes (and patches) a copy of the context MkIV/MkXL 
# files we are required to load and compile the partial TUC files created 
# by each sub-document. 

srcDir=$(pwd)
scriptsDir=$srcDir/scripts
pcontextDir=$HOME/.config/pcontext
mkivDir=$(mtxrun --locate l-lua.lua)
mkivDir=$(dirname $mkivDir)

tpcontextDir="t-pcontext/tex/context/third/pcontext"
texmfLocalDir=$(mtxrun --resolve-path TEXMFLOCAL)

mkdir -p $pcontextDir/context

pushd $HOME/bin

ln -fs $scriptsDir/compileParallelTUC .
ln -fs $scriptsDir/typesetParallelDocs .
ln -fs $scriptsDir/clearParallelDocs .

popd

ln -t $pcontextDir -fs $scriptsDir/pContext

mkivLuaFiles=$(cat<<MKIV_LUA_FILE_LIST
  l-lua.lua
  l-math.lua
  l-lpeg.lua
  l-file.lua
  l-io.lua
  l-table.lua
  l-unicode.lua
  l-package.lua
  util-sto.lua
  util-str.lua
  util-tab.lua
  util-ran.lua
  util-prs.lua
  util-pck.lua
  trac-set.lua
  luat-log.lua
  trac-inf.lua
  supp-ran.lua
MKIV_LUA_FILE_LIST
)
#  core-uti.lua

loaderFile=$pcontextDir/context/contextLoader.lua

cat << LOADER_HEADER > $loaderFile
-- autogenerated by setup... do not edit

-- tpcontextDir  = "$texmfLocalDir/$tpcontextDir"
-- texmfLocalDir = "$texmfLocalDir"

utilities  = utilities  or { }
texio      = texio      or { }
interfaces = interfaces or { }
tex        = tex        or { }
context    = context    or { }
status     = status     or { }

function interfaces.implement(aHash)
end

function tex.getcount(aName)
  return 0
end

function context.setxvalue(aName,aValue)
end

function texio.write_nl(...)
  print(...)
end

lfs    = require('lfs')
pprint = require('pprint')

LOADER_HEADER

for aLuaFile in $mkivLuaFiles ; do
  cp $mkivDir/$aLuaFile $pcontextDir/context
  if test -f "patches/${aLuaFile}.patch" ; then
    patch -d$pcontextDir -p1 < patches/${aLuaFile}.patch
  fi
  echo "dofile('$pcontextDir/context/$aLuaFile')" >> $loaderFile
done
echo "" >> $loaderFile
echo "return pcontext" >> $loaderFile
echo "" >> $loaderFile

